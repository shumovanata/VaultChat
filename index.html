<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: #fff; height: 100vh; overflow: hidden; }
        .chat-container { height: 100vh; display: flex; flex-direction: column; background: #000; }
        .header { background: linear-gradient(135deg, #0088cc 0%, #005f99 100%); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 18px; font-weight: 600; color: white; }
        .close-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .close-btn:hover { background: rgba(255,255,255,0.3); }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; background: #111; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .message.user { align-items: flex-end; }
        .message.other { align-items: flex-start; }
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; }
        .message.user .message-bubble { background: #0088cc; border-bottom-right-radius: 4px; color: white; }
        .message.other .message-bubble { background: #333; border-bottom-left-radius: 4px; color: #fff; }
        .message-time { font-size: 12px; color: #888; margin-top: 5px; }
        .input-container { padding: 15px 20px; background: #000; border-top: 1px solid #333; display: flex; gap: 10px; }
        .message-input { flex: 1; padding: 12px 16px; border: 1px solid #333; border-radius: 20px; background: #111; color: #fff; font-size: 16px; outline: none; }
        .message-input::placeholder { color: #888; }
        .send-btn { width: 44px; height: 44px; border: none; border-radius: 50%; background: #0088cc; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .send-btn:hover { background: #006699; }
        .send-btn:disabled { background: #333; cursor: not-allowed; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #888; text-align: center; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <div class="header-title">üí¨ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
            <button class="close-btn" onclick="closeChat()">√ó</button>
        </div>
        <div class="messages-container" id="messagesContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <p>–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É</p>
            </div>
        </div>
        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>‚û§</button>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        let messages = [];
        let lastMessageId = 0;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        async function loadMessages() {
            try {
                const response = await fetch('https://api.telegram.org/bot<8107485627:AAHMAoWk0iqo8Fq8xuYReuHoAaoysh2ktgY>/getChatHistory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lastId: lastMessageId })
                });
                const data = await response.json();
                if (data.messages) {
                    data.messages.forEach(msg => {
                        if (msg.id > lastMessageId) lastMessageId = msg.id;
                        if (!messages.find(m => m.id === msg.id)) {
                            messages.push(msg);
                        }
                    });
                    renderMessages();
                }
            } catch (e) {
                console.log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
            }
        }

        function renderMessages() {
            messagesContainer.innerHTML = '';
            if (messages.length === 0) {
                messagesContainer.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É</p></div>`;
                return;
            }
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.from === Telegram.WebApp.initDataUnsafe.user.id ? 'user' : 'other'}`;
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                div.innerHTML = `<div class="message-bubble">${msg.text}</div><div class="message-time">${time}</div>`;
                messagesContainer.appendChild(div);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            Telegram.WebApp.sendData(JSON.stringify({ action: 'send_message', text }));

            messageInput.value = '';
            toggleSendButton();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function toggleSendButton() {
            sendBtn.disabled = !messageInput.value.trim();
        }

        function closeChat() {
            Telegram.WebApp.close();
        }

        // Polling –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(loadMessages, 5000);
        loadMessages(); // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

        messageInput.addEventListener('input', toggleSendButton);
        Telegram.WebApp.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å').show().onClick(sendMessage);
    </script>
</body>
</html>
